name: X-Master-Bot

on:
  schedule:
    # Ø§Ø¬Ø±Ø§ Ù‡Ø± 30 Ø¯Ù‚ÛŒÙ‚Ù‡ØŒ Ø³Ø§Ø¹Ø§Øª ÙØ¹Ø§Ù„ Ø§ÛŒØ±Ø§Ù† (6:30 ØªØ§ 18:30 UTC)
    - cron: "0,30 6-18 * * *"
  workflow_dispatch:
    inputs:
      test_mode:
        description: "Ø§Ø¬Ø±Ø§ Ø¯Ø± Ø­Ø§Ù„Øª ØªØ³Øª (Ú©Ù…ØªØ± Ø¨Ø§Ø²Ø¯ÛŒØ¯)"
        required: false
        default: "false"
        type: boolean

jobs:
  run-bot:
    runs-on: ubuntu-22.04
    timeout-minutes: 25

    steps:
      # ========================================
      # Ù…Ø±Ø­Ù„Ù‡ 1: Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯Ù‡Ø§
      # ========================================
      - name: ğŸ“¥ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯Ù‡Ø§
        uses: actions/checkout@v4

      # ========================================
      # Ù…Ø±Ø­Ù„Ù‡ 2: Ù†ØµØ¨ Ùˆ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Tor
      # ========================================
      - name: ğŸ§… Ù†ØµØ¨ Ùˆ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Tor
        run: |
          echo ">>> Ù†ØµØ¨ Tor..."
          sudo apt-get update
          sudo apt-get install -y tor curl

          echo ">>> Ø´Ø±ÙˆØ¹ Ø³Ø±ÙˆÛŒØ³ Tor..."
          sudo service tor start

          echo ">>> ØµØ¨Ø± Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ (15 Ø«Ø§Ù†ÛŒÙ‡)..."
          sleep 15

          echo ">>> ØªØ³Øª Ø§ØªØµØ§Ù„ Tor..."
          for i in 1 2 3; do
            if curl --socks5-hostname 127.0.0.1:9050 --max-time 30 https://check.torproject.org/api/ip 2>/dev/null; then
              echo ""
              echo "âœ… Ø§ØªØµØ§Ù„ Tor Ø¨Ø±Ù‚Ø±Ø§Ø± Ø§Ø³Øª!"
              exit 0
            fi
            echo "â³ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯ $i/3..."
            sleep 5
          done

          echo "âŒ Ø§ØªØµØ§Ù„ Tor Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯!"
          exit 1

      # ========================================
      # Ù…Ø±Ø­Ù„Ù‡ 3: Ù†ØµØ¨ Ù¾Ø§ÛŒØªÙˆÙ†
      # ========================================
      - name: ğŸ Ù†ØµØ¨ Ù¾Ø§ÛŒØªÙˆÙ†
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: "pip"

      # ========================================
      # Ù…Ø±Ø­Ù„Ù‡ 4: Ù†ØµØ¨ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§
      # ========================================
      - name: ğŸ“¦ Ù†ØµØ¨ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          python -m playwright install chromium
          sudo $(which python) -m playwright install-deps chromium

      # ========================================
      # Ù…Ø±Ø­Ù„Ù‡ 5: Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª
      # ========================================
      - name: ğŸš€ Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª Ù‡ÙˆØ´Ù…Ù†Ø¯
        timeout-minutes: 18
        env:
          X_TARGET_URL: ${{ secrets.X_TARGET_URL }}
          X_COOKIE_JSON: ${{ secrets.X_COOKIE_JSON }}
          X_USERNAME: ${{ secrets.X_USERNAME }}
        run: |
          if [ "${{ github.event.inputs.test_mode }}" == "true" ]; then
            python main.py --test-mode
          else
            python main.py
          fi

      # ========================================
      # Ù…Ø±Ø­Ù„Ù‡ 6: Ø°Ø®ÛŒØ±Ù‡ Ú¯Ø²Ø§Ø±Ø´
      # ========================================
      - name: ğŸ“Š Ø°Ø®ÛŒØ±Ù‡ Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: report-${{ github.run_number }}-${{ github.run_attempt }}
          path: report.txt
          retention-days: 14
          if-no-files-found: ignore

      # ========================================
      # Ù…Ø±Ø­Ù„Ù‡ 6.5: Ø°Ø®ÛŒØ±Ù‡ Ø§Ø³Ú©Ø±ÛŒÙ†â€ŒØ´Ø§Øªâ€ŒÙ‡Ø§ (Debug)
      # ========================================
      - name: ğŸ“¸ Ø°Ø®ÛŒØ±Ù‡ Ø§Ø³Ú©Ø±ÛŒÙ†â€ŒØ´Ø§Øªâ€ŒÙ‡Ø§
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ github.run_number }}-${{ github.run_attempt }}
          path: "*.png"
          retention-days: 3
          if-no-files-found: ignore

      # ========================================
      # Ù…Ø±Ø­Ù„Ù‡ 7: Ø®Ù„Ø§ØµÙ‡ Ø§Ø¬Ø±Ø§
      # ========================================
      - name: ğŸ“ˆ Ù†Ù…Ø§ÛŒØ´ Ø®Ù„Ø§ØµÙ‡
        if: always()
        run: |
          echo "========================================"
          echo "ğŸ“Š Ø®Ù„Ø§ØµÙ‡ Ø§Ø¬Ø±Ø§ÛŒ X Master Bot"
          echo "========================================"
          if [ -f report.txt ]; then
            tail -5 report.txt
          else
            echo "Ú¯Ø²Ø§Ø±Ø´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯"
          fi
          echo "========================================"
